<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Housing Map</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="grid-overlay.css">
</head>
<body>
    <div class="map-container">
        <div class="map-background" id="mapBackground">
            <!-- House plots will be dynamically positioned here -->
        </div>
    </div>

    <div class="legend">
        <h3>Legend</h3>
        <div class="legend-item">
            <div class="legend-color available"></div>
            <span>Available</span>
        </div>
        <div class="legend-item">
            <div class="legend-color occupied"></div>
            <span>Occupied</span>
        </div>
        <div style="margin-top: 10px; font-size: 10px; color: #ccc;">
            Press <strong>G</strong> to toggle grid
        </div>
    </div>

    <script>
        // Housing data from CSV
        const housingData = {
            4: "Ahmelya",
        };

        // House plot positions loaded from external JSON file
        let plotPositions = [];
        let mapImageData = {};

        async function loadPlotPositions() {
            try {
                const response = await fetch('plot-positions.json');
                const data = await response.json();
                plotPositions = data.plotPositions;
                mapImageData = data.referenceImage;
                console.log('Plot positions loaded successfully:', data);
            } catch (error) {
                console.error('Error loading plot positions:', error);
                // Fallback to empty array if JSON fails to load
                plotPositions = [];
            }
        }

        function createHousePlots() {
            const mapBackground = document.getElementById('mapBackground');
            
            // Clear existing house plots only (don't remove flight markers!)
            const existingPlots = mapBackground.querySelectorAll('.house-plot');
            existingPlots.forEach(plot => plot.remove());
            
            plotPositions.forEach((position) => {
                const plot = document.createElement('div');
                plot.className = 'house-plot';
                plot.textContent = position.plotNumber;
                
                // Check if plot is occupied
                if (housingData[position.plotNumber]) {
                    plot.classList.add('occupied');
                    
                    // Add tooltip with buyer name
                    const tooltip = document.createElement('div');
                    tooltip.className = 'plot-info';
                    tooltip.textContent = `Plot ${position.plotNumber}: ${housingData[position.plotNumber]}`;
                    plot.appendChild(tooltip);
                } else {
                    // Add tooltip for available plot
                    const tooltip = document.createElement('div');
                    tooltip.className = 'plot-info';
                    tooltip.textContent = `Plot ${position.plotNumber}: Available`;
                    plot.appendChild(tooltip);
                }
                
                // Position the plot
                plot.style.left = position.x + 'px';
                plot.style.top = position.y + 'px';
                
                mapBackground.appendChild(plot);
            });
        }

        function updatePlotPositions() {
            const mapBackground = document.getElementById('mapBackground');
            const plots = document.querySelectorAll('.house-plot');
            
            if (plots.length === 0) return;
            
            // Get the actual map image dimensions and position (same logic as grid)
            const mapImage = new Image();
            mapImage.onload = function() {
                const mapRect = mapBackground.getBoundingClientRect();
                const containerWidth = mapRect.width;
                const containerHeight = mapRect.height;
                
                // Calculate the actual displayed image dimensions (maintaining aspect ratio)
                const imageAspectRatio = mapImage.width / mapImage.height;
                const containerAspectRatio = containerWidth / containerHeight;
                
                let imageWidth, imageHeight, offsetX, offsetY;
                
                if (imageAspectRatio > containerAspectRatio) {
                    // Image is wider than container
                    imageWidth = containerWidth;
                    imageHeight = containerWidth / imageAspectRatio;
                    offsetX = 0;
                    offsetY = (containerHeight - imageHeight) / 2;
                } else {
                    // Image is taller than container
                    imageHeight = containerHeight;
                    imageWidth = containerHeight * imageAspectRatio;
                    offsetX = (containerWidth - imageWidth) / 2;
                    offsetY = 0;
                }
                
                // Calculate scale factor from original image to displayed image
                const scaleX = imageWidth / mapImage.width;
                const scaleY = imageHeight / mapImage.height;
                
                // Update plot positions using the same logic as grid
                plots.forEach((plot, index) => {
                    const originalPos = plotPositions[index];
                    if (originalPos) {
                        const scaledX = offsetX + (originalPos.x * scaleX);
                        const scaledY = offsetY + (originalPos.y * scaleY);
                        
                        plot.style.left = scaledX + 'px';
                        plot.style.top = scaledY + 'px';
                    }
                });
            };
            
            mapImage.src = 'map.jpg';
        }

        // Initialize the map
        document.addEventListener('DOMContentLoaded', async function() {
            // Load plot positions from JSON file first
            await loadPlotPositions();
            
            // Create house plots after positions are loaded
            createHousePlots();
            
            // Update positions on window resize
            let plotResizeTimeout;
            window.addEventListener('resize', function() {
                // Clear existing timeout to prevent multiple rapid calls
                clearTimeout(plotResizeTimeout);
                // Update immediately for responsiveness
                updatePlotPositions();
            });
            
            // Initial position update
            setTimeout(updatePlotPositions, 100);
            
            // Create initial grid overlay
            //setTimeout(createGridOverlay, 500);
        });
    </script>
    <script src="grid-overlay.js"></script>

<script>

/**
 * Overlay icons on #mapBackground using coordinates from a JSON file.
 * JSON shape: { positions: [{x, y}, ...] }
 */

(async function overlayIcons(opts) {
  const {
    jsonUrl = 'flight-positions.json',
    iconSrc = 'icon_taxi_alliance.png',
    markerClass = 'icon-marker',
    markerSize = 28,
    mapSelector = '#mapBackground',
    mapImageSrc = 'map.jpg'
  } = opts || {};

  const mapBackground = document.querySelector(mapSelector);
  if (!mapBackground) return;

  // Create or update styles
  const styleId = 'overlay-icons-style-' + markerClass;
  let st = document.getElementById(styleId);
  if (!st) {
    st = document.createElement('style');
    st.id = styleId;
    document.head.appendChild(st);
  }
  st.textContent = `
    .${markerClass} {
      position: absolute;
      width: ${markerSize}px;
      height: ${markerSize}px;
      pointer-events: none;
      transform: translate(-50%, -100%);
      z-index: 2;
      filter: drop-shadow(0 0 3px rgba(0,0,0,0.8));
    }
  `;

  let positions = [];
  let markers = [];

  try {
    const res = await fetch(jsonUrl);
    const data = await res.json();
    positions = Array.isArray(data.positions) ? data.positions : [];
  } catch (e) {
    console.error('overlayIcons: failed to load', jsonUrl, e);
    return;
  }

  function buildMarkers() {
    // clear
    markers.forEach(m => m.remove());
    markers = [];

    positions.forEach(p => {
      const div = document.createElement('div');
      div.className = markerClass;
      div.style.backgroundImage = `url(${iconSrc})`;
      div.style.backgroundSize = 'contain';
      div.style.backgroundRepeat = 'no-repeat';
      div.style.backgroundPosition = 'center';
      mapBackground.appendChild(div);
      markers.push(div);
    });
  }

  function reposition() {
    const mapRect = mapBackground.getBoundingClientRect();
    const W = mapRect.width, H = mapRect.height;

    const img = new Image();
    img.onload = () => {
      const ARimg = img.width / img.height;
      const ARcnt = W / H;

      let w, h, offX, offY;
      if (ARimg > ARcnt) {
        w = W; h = W / ARimg; offX = 0; offY = (H - h) / 2;
      } else {
        h = H; w = H * ARimg; offX = (W - w) / 2; offY = 0;
      }

      const sx = w / img.width;
      const sy = h / img.height;

      markers.forEach((m, i) => {
        const p = positions[i];
        if (!p) return;
        m.style.left = (offX + p.x * sx) + 'px';
        m.style.top  = (offY + p.y * sy) + 'px';
      });
    };
    img.src = mapImageSrc;
  }

  buildMarkers();
  reposition();

  let t;
  window.addEventListener('resize', () => {
    clearTimeout(t);
    t = setTimeout(reposition, 50);
  });
})({
  jsonUrl: 'flight-positions.json',
  iconSrc: 'icon_taxi_alliance.png',
  markerClass: 'flight-marker-simple',
  markerSize: 32,
  mapSelector: '#mapBackground',
  mapImageSrc: 'map.jpg'
});
</script>


    
</body>
</html>
